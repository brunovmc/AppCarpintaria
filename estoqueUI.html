<script>
  window.EstoqueUI = (() => {
    let cardAberto = null;
    let delegationInit = false;

    let opcoesProdutos = [];
    let opcoesProducao = [];

    /* =========================
       HELPERS
    ========================== */
    function el() {
      return {
        formulario: document.getElementById('formulario'),
        lista: document.getElementById('lista'),

        // Form
        tipo: document.getElementById('tipo'),
        item: document.getElementById('item'),
        quantidade: document.getElementById('quantidade'),
        unidade: document.getElementById('unidade'),
        categoria: document.getElementById('categoria'),
        fornecedor: document.getElementById('fornecedor'),
        valor_unit: document.getElementById('valor_unit'),
        observacao: document.getElementById('observacao'),

        comprimento_cm: document.getElementById('comprimento_cm'),
        largura_cm: document.getElementById('largura_cm'),
        espessura_cm: document.getElementById('espessura_cm'),

        potencia: document.getElementById('potencia'),
        voltagem: document.getElementById('voltagem'),
        comprado_em: document.getElementById('comprado_em'),
        vida_util_mes: document.getElementById('vida_util_mes'),

        equipamentoFields: document.getElementById('equipamentoFields'),
        madeiraFields: document.getElementById('madeiraFields'),
        formTitulo: document.getElementById('formTitulo'),

        // Painel de filtro (inline)
        filtroTipo: document.getElementById('filtroTipo'),
        filtroCategoria: document.getElementById('filtroCategoria')
      };
    }

    function limparVazios(lista) {
      return (Array.isArray(lista) ? lista : [])
        .map(v => (v ?? '').toString().trim())
        .filter(v => v !== '');
    }

    function parseNumeroInput(valor) {
      const s = String(valor ?? '').trim();
      if (s === '') return 0;
      const n = Number(s.replace(',', '.'));
      return isNaN(n) ? 0 : n;
    }

    function garantirOpcao(select, valor) {
      if (!select || !valor) return;
      const existe = [...select.options].some(o => o.value === valor);
      if (!existe) {
        const opt = document.createElement('option');
        opt.value = valor;
        opt.textContent = valor;
        select.appendChild(opt);
      }
    }

    function atualizarQuantidadeMadeira() {
      const f = el();
      if (!f.tipo || f.tipo.value !== 'MADEIRA') return;
      if (!f.quantidade) return;

      const comp = parseNumeroInput(f.comprimento_cm?.value);
      const larg = parseNumeroInput(f.largura_cm?.value);
      const espes = parseNumeroInput(f.espessura_cm?.value);

      if (!comp || !larg || !espes) {
        f.quantidade.value = '';
        return;
      }

      const m3 = (comp * larg * espes) / 1000000;
      f.quantidade.value = m3.toFixed(2);
    }

    function setOpcoesAdicao({ produtos, producao } = {}) {
      opcoesProdutos = Array.isArray(produtos) ? produtos : [];
      opcoesProducao = Array.isArray(producao) ? producao : [];

      const selects = document.querySelectorAll('.add-destino-tipo');
      selects.forEach(sel => {
        if (sel.value) {
          atualizarDestinoPorTipo(sel);
        }
      });
    }

    function renderOpcoesDestino(tipo, selecionadoId) {
      const lista = tipo === 'PRODUCAO' ? opcoesProducao : opcoesProdutos;
      const placeholder = '<option value="">Selecione</option>';
      const opts = lista.map(i => {
        const val = tipo === 'PRODUCAO' ? i.producao_id : i.produto_id;
        const label = tipo === 'PRODUCAO'
          ? (i.nome_ordem || i.nome_produto || i.producao_id)
          : (i.nome_produto || i.produto_id);
        const selected = val === selecionadoId ? 'selected' : '';
        return `<option value="${val}" ${selected}>${label}</option>`;
      }).join('');
      return placeholder + opts;
    }

    function atualizarDestinoPorTipo(selectTipo) {
      if (!selectTipo) return;
      const targetId = selectTipo.dataset.targetId || '';
      const selectRef = document.getElementById(targetId);
      if (!selectRef) return;

      const tipo = String(selectTipo.value || '').toUpperCase();
      if (!tipo) {
        selectRef.innerHTML = '<option value="">Selecione</option>';
        return;
      }

      selectRef.innerHTML = renderOpcoesDestino(tipo, selectRef.value || '');
    }

    function resetarAdicaoDestino(estoqueId) {
      const tipo = document.getElementById(`addTipo_${estoqueId}`);
      const ref = document.getElementById(`addRef_${estoqueId}`);
      const qtd = document.getElementById(`addQtd_${estoqueId}`);

      if (tipo) tipo.value = '';
      if (ref) ref.innerHTML = '<option value="">Selecione</option>';
      if (qtd) qtd.value = '';
    }

    /* =========================
       FORMULARIO
    ========================== */
    function abrirFormularioNovo() {
      resetFormulario();
      mostrarFormulario();
    }

    function mostrarFormulario() {
      const { formulario } = el();
      if (!formulario) return;

      formulario.style.display = 'block';

      requestAnimationFrame(() => {
        formulario.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
    }

    function fecharFormulario() {
      const { formulario } = el();
      if (!formulario) return;

      formulario.style.display = 'none';
      resetFormulario();

      if (window.EstoqueController) {
        EstoqueController.limparEdicao();
      }
    }

    function preencherFormulario(data) {
      const f = el();

      if (f.tipo) f.tipo.value = data.tipo || '';
      if (f.unidade) f.unidade.value = data.unidade || '';

      if (f.item) f.item.value = data.item || '';
      if (f.quantidade) f.quantidade.value = data.quantidade || '';

      if (f.categoria) f.categoria.value = data.categoria || '';
      if (f.fornecedor) f.fornecedor.value = data.fornecedor || '';

      if (f.valor_unit) f.valor_unit.value = data.valor_unit || '';
      if (f.observacao) f.observacao.value = data.observacao || '';

      if (f.comprimento_cm) f.comprimento_cm.value = data.comprimento_cm || '';
      if (f.largura_cm) f.largura_cm.value = data.largura_cm || '';
      if (f.espessura_cm) f.espessura_cm.value = data.espessura_cm || '';

      if (f.potencia) f.potencia.value = data.potencia || '';
      if (f.voltagem) f.voltagem.value = data.voltagem || '';
      if (f.comprado_em) f.comprado_em.value = data.comprado_em || '';
      if (f.vida_util_mes) f.vida_util_mes.value = data.vida_util_mes || '';

      if (f.formTitulo) f.formTitulo.innerText = 'Editar Item';
      handleTipoChange();
    }

    function resetFormulario() {
      const f = el();

      [
        f.tipo,
        f.item,
        f.quantidade,
        f.unidade,
        f.categoria,
        f.fornecedor,
        f.valor_unit,
        f.observacao,
        f.comprimento_cm,
        f.largura_cm,
        f.espessura_cm,
        f.potencia,
        f.voltagem,
        f.comprado_em,
        f.vida_util_mes
      ].forEach(i => i && (i.value = ''));

      if (f.equipamentoFields) f.equipamentoFields.classList.add('hidden');
      if (f.madeiraFields) f.madeiraFields.classList.add('hidden');
      if (f.quantidade) f.quantidade.readOnly = false;
      if (f.formTitulo) f.formTitulo.innerText = 'Novo Item';
    }

    function handleTipoChange() {
      const { tipo, equipamentoFields, madeiraFields, quantidade, unidade } = el();
      if (!tipo) return;

      const isEquip = tipo.value === 'EQUIPAMENTO';
      const isMadeira = tipo.value === 'MADEIRA';

      if (equipamentoFields) {
        equipamentoFields.classList.toggle('hidden', !isEquip);
      }

      if (madeiraFields) {
        madeiraFields.classList.toggle('hidden', !isMadeira);
      }

      if (quantidade) {
        quantidade.readOnly = isMadeira;
      }

      if (isMadeira && unidade) {
        garantirOpcao(unidade, 'M3');
        unidade.value = 'M3';
        atualizarQuantidadeMadeira();
      }

      if (!isMadeira && madeiraFields) {
        const inputs = madeiraFields.querySelectorAll('input');
        inputs.forEach(i => (i.value = ''));
      }
    }

    /* =========================
       SELECTS (RENDER ONLY)
    ========================== */
    function renderTipos(lista) {
      const { tipo } = el();
      if (!tipo) return;

      const clean = limparVazios(lista);

      tipo.innerHTML = '<option value="">Selecione</option>';
      clean.forEach(v => {
        const o = document.createElement('option');
        o.value = v;
        o.textContent = v;
        tipo.appendChild(o);
      });
    }

    function renderUnidades(lista) {
      const { unidade } = el();
      if (!unidade) return;

      const clean = limparVazios(lista);

      unidade.innerHTML = '<option value="">Selecione</option>';
      clean.forEach(v => {
        const o = document.createElement('option');
        o.value = v;
        o.textContent = v;
        unidade.appendChild(o);
      });
    }

    function renderCategorias(lista) {
      const { categoria } = el();
      if (!categoria) return;

      const clean = limparVazios(lista);

      if (categoria.tagName === 'SELECT') {
        categoria.innerHTML = '<option value="">Selecione</option>';
        clean.forEach(v => {
          const o = document.createElement('option');
          o.value = v;
          o.textContent = v;
          categoria.appendChild(o);
        });
      }
    }

    function renderFornecedores(lista) {
      const { fornecedor } = el();
      if (!fornecedor) return;

      const clean = limparVazios(lista);

      if (fornecedor.tagName === 'SELECT') {
        fornecedor.innerHTML = '<option value="">Selecione</option>';
        clean.forEach(v => {
          const o = document.createElement('option');
          o.value = v;
          o.textContent = v;
          fornecedor.appendChild(o);
        });
      }
    }

    /* =========================
       SELECTS DO PAINEL DE FILTRO
    ========================== */
    function renderFiltroTipos(lista) {
      const { filtroTipo } = el();
      if (!filtroTipo) return;

      const clean = limparVazios(lista);

      filtroTipo.innerHTML = '<option value="">Tipo (todos)</option>';
      clean.forEach(v => {
        const o = document.createElement('option');
        o.value = v;
        o.textContent = v;
        filtroTipo.appendChild(o);
      });
    }

    function renderFiltroCategorias(lista) {
      const { filtroCategoria } = el();
      if (!filtroCategoria) return;

      const clean = limparVazios(lista);

      filtroCategoria.innerHTML = '<option value="">Categoria (todas)</option>';
      clean.forEach(v => {
        const o = document.createElement('option');
        o.value = v;
        o.textContent = v;
        filtroCategoria.appendChild(o);
      });
    }

    /* =========================
       LISTA + CARDS
    ========================== */
    function renderLista(itens) {
      const { lista } = el();
      if (!lista) return;

      lista.innerHTML = '';

      if (!Array.isArray(itens) || itens.length === 0) {
        lista.innerHTML = '<p>Nenhum item no estoque.</p>';
        return;
      }

      itens.forEach(i => {
        const div = document.createElement('div');
        div.className = 'card';
        div.dataset.id = i.ID;
        const isMadeira = String(i.tipo || '').toUpperCase() === 'MADEIRA';

        div.innerHTML = `
          <div class="card-resumo">
            <strong>${i.item}</strong><br>
            ${i.tipo} - ${i.categoria || '-'}<br>
            ${i.quantidade || 0} ${i.unidade || ''}
          </div>

          <button class="ver-mais">Ver mais</button>

          <div class="card-detalhes">
            <button class="fechar-card">X</button>

            <p><b>Fornecedor:</b> ${i.fornecedor || '-'}</p>
            <p><b>Valor unitario:</b> R$ ${Number(i.valor_unit || 0).toFixed(2)}</p>
            <p><b>Observacao:</b> ${i.observacao || '-'}</p>

            ${isMadeira ? `
              <p><b>Medidas (cm):</b> ${i.comprimento_cm || '-'} x ${i.largura_cm || '-'} x ${i.espessura_cm || '-'}</p>
            ` : ''}

            ${i.tipo === 'EQUIPAMENTO' ? `
              <p><b>Potencia:</b> ${i.potencia || '-'}</p>
              <p><b>Voltagem:</b> ${i.voltagem || '-'}</p>
            ` : ''}

            <div class="bloco">
              <p><b>Adicionar a</b></p>
              <div class="linha-add-destino">
                <select
                  id="addTipo_${i.ID}"
                  class="add-destino-tipo"
                  data-estoque-id="${i.ID}"
                  data-target-id="addRef_${i.ID}"
                >
                  <option value="">Selecione</option>
                  <option value="PRODUTO">Produto</option>
                  <option value="PRODUCAO">Producao</option>
                </select>
                <select id="addRef_${i.ID}" class="add-destino-ref" data-estoque-id="${i.ID}">
                  <option value="">Selecione</option>
                </select>
                <input
                  id="addQtd_${i.ID}"
                  class="add-destino-qtd"
                  type="number"
                  step="0.01"
                  min="0"
                  placeholder="Qtd (${i.unidade || ''})"
                >
                <button class="btn-add-destino" data-estoque-id="${i.ID}">Adicionar</button>
              </div>
            </div>

            <div class="acoes">
              <button onclick="EstoqueController.editar('${i.ID}')">Editar</button>
              <button onclick="EstoqueController.excluir('${i.ID}')">Excluir</button>
            </div>
          </div>
        `;

        lista.appendChild(div);
      });

      initDelegation();
    }

    /* =========================
       EVENT DELEGATION (CORE)
    ========================== */
    function initDelegation() {
      if (delegationInit) return;
      delegationInit = true;

      document.addEventListener('click', e => {
        const card = e.target.closest('.card');
        const lista = document.getElementById('lista');

        if (card && lista && !lista.contains(card)) return;

        if (e.target.classList.contains('ver-mais')) {
          e.stopPropagation();
          abrirCard(card);
          return;
        }

        if (e.target.classList.contains('fechar-card')) {
          e.stopPropagation();
          fecharCard();
          return;
        }

        if (e.target.classList.contains('btn-add-destino')) {
          const estoqueId = e.target.dataset.estoqueId;
          const tipo = document.getElementById(`addTipo_${estoqueId}`)?.value || '';
          const destinoId = document.getElementById(`addRef_${estoqueId}`)?.value || '';
          const quantidade = document.getElementById(`addQtd_${estoqueId}`)?.value || '';

          if (window.EstoqueController) {
            EstoqueController.adicionarMaterialDestino(estoqueId, tipo, destinoId, quantidade);
          }
          return;
        }

        if (cardAberto && !cardAberto.contains(e.target)) {
          fecharCard();
        }
      });

      document.addEventListener('change', e => {
        if (e.target.classList.contains('add-destino-tipo')) {
          atualizarDestinoPorTipo(e.target);
        }
      });
    }

    function abrirCard(card) {
      if (!card) return;

      if (cardAberto && cardAberto !== card) {
        fecharCard();
      }
      card.classList.add('aberto');
      cardAberto = card;
    }

    function fecharCard() {
      if (!cardAberto) return;
      cardAberto.classList.remove('aberto');
      cardAberto = null;
    }

    /* =========================
       API PUBLICA
    ========================== */
    return {
      abrirFormularioNovo,
      mostrarFormulario,
      fecharFormulario,
      preencherFormulario,
      resetFormulario,
      handleTipoChange,
      renderLista,

      renderTipos,
      renderUnidades,
      renderCategorias,
      renderFornecedores,

      renderFiltroTipos,
      renderFiltroCategorias,

      setOpcoesAdicao,
      resetarAdicaoDestino,
      atualizarQuantidadeMadeira
    };

  })();
</script>
