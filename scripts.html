<script>
  /* =========================
     NAV / ABAS
  ========================== */
  function trocarAba(nome) {
    document.querySelectorAll('.aba')
      .forEach(a => a.classList.add('hidden'));

    const aba = document.getElementById('aba-' + nome);
    if (aba) aba.classList.remove('hidden');
    setTopBars(nome);

    if (nome === 'estoque' && window.EstoqueController) {
      EstoqueController.init();
      aplicarBuscaEstoque(); // reaplica filtros ao voltar pra aba
    }

    if (nome === 'compras' && window.ComprasController) {
      ComprasController.init();
      aplicarBuscaCompras();
    }

    if (nome === 'produtos' && window.ProdutosController) {
      ProdutosController.init();
      aplicarBuscaProdutos();
    }

    if (nome === 'producao' && window.ProducaoController) {
      ProducaoController.init();
    }
  }

  function setTopBars(nome) {
    const topEstoque = document.getElementById('topBarEstoque');
    const topCompras = document.getElementById('topBarCompras');
    const topProdutos = document.getElementById('topBarProdutos');

    if (topEstoque) topEstoque.classList.toggle('hidden', nome !== 'estoque');
    if (topCompras) topCompras.classList.toggle('hidden', nome !== 'compras');
    if (topProdutos) topProdutos.classList.toggle('hidden', nome !== 'produtos');

    if (nome !== 'estoque') fecharPainelFiltro();
    if (nome !== 'compras') fecharPainelFiltroCompras();
  }

  function acaoPrimaria() {
    const abaAtiva = document.querySelector('.aba:not(.hidden)');
    if (!abaAtiva) return;

    if (abaAtiva.id === 'aba-estoque') {
      if (window.EstoqueUI?.abrirFormularioNovo) {
        EstoqueUI.abrirFormularioNovo();
      } else if (window.EstoqueUI?.abrirFormulario) {
        EstoqueUI.abrirFormulario();
      }
    } else if (abaAtiva.id === 'aba-compras') {
      if (window.ComprasUI?.abrirFormularioNovo) {
        ComprasUI.abrirFormularioNovo();
      } else if (window.ComprasUI?.abrirFormulario) {
        ComprasUI.abrirFormulario();
      }
    } else if (abaAtiva.id === 'aba-produtos') {
      if (window.ProdutosUI?.abrirFormularioNovo) {
        ProdutosUI.abrirFormularioNovo();
      } else if (window.ProdutosUI?.abrirFormulario) {
        ProdutosUI.abrirFormulario();
      }
    } else if (abaAtiva.id === 'aba-producao') {
      if (window.ProducaoUI?.abrirFormularioNovo) {
        ProducaoUI.abrirFormularioNovo();
      } else if (window.ProducaoUI?.abrirFormulario) {
        ProducaoUI.abrirFormulario();
      }
    }
  }

  /* =========================
     TOAST
  ========================== */
  function mostrarToast(msg, tipo = '') {
    const t = document.getElementById('toast');
    if (!t) return;

    t.textContent = msg;
    t.className = `toast show ${tipo}`;

    setTimeout(() => {
      t.classList.remove('show');
    }, 2500);
  }

  /* =========================
     BUSCA + FILTROS (STATE)
  ========================== */
  const buscaState = {
    texto: '',
    tipo: '',
    categoria: '',
    unidade: ''
  };

  const buscaStateCompras = {
    texto: '',
    tipo: '',
    categoria: '',
    unidade: ''
  };

  const buscaStateProdutos = {
    texto: ''
  };

  function debounce(fn, delay = 250) {
    let t = null;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), delay);
    };
  }

  function estoqueEstaAtivo() {
    const abaEstoque = document.getElementById('aba-estoque');
    return abaEstoque && !abaEstoque.classList.contains('hidden');
  }

  function comprasEstaAtivo() {
    const abaCompras = document.getElementById('aba-compras');
    return abaCompras && !abaCompras.classList.contains('hidden');
  }

  function produtosEstaAtivo() {
    const abaProdutos = document.getElementById('aba-produtos');
    return abaProdutos && !abaProdutos.classList.contains('hidden');
  }

  function lerFiltrosDoPainel() {
    const tipo = document.getElementById('filtroTipo');
    const categoria = document.getElementById('filtroCategoria');
    const unidade = document.getElementById('filtroUnidade');

    buscaState.tipo = tipo ? (tipo.value || '') : buscaState.tipo;
    buscaState.categoria = categoria ? (categoria.value || '') : buscaState.categoria;
    buscaState.unidade = unidade ? (unidade.value || '') : buscaState.unidade;
  }

  function lerFiltrosDoPainelCompras() {
    const tipo = document.getElementById('filtroTipoCompras');
    const categoria = document.getElementById('filtroCategoriaCompras');
    const unidade = document.getElementById('filtroUnidadeCompras');

    buscaStateCompras.tipo = tipo ? (tipo.value || '') : buscaStateCompras.tipo;
    buscaStateCompras.categoria = categoria ? (categoria.value || '') : buscaStateCompras.categoria;
    buscaStateCompras.unidade = unidade ? (unidade.value || '') : buscaStateCompras.unidade;
  }

  function aplicarBuscaEstoque() {
    if (!estoqueEstaAtivo()) return;

    if (!window.EstoqueStore || !window.EstoqueUI) return;
    if (!EstoqueStore.isLoaded()) return;

    const texto = (buscaState.texto || '').trim();
    const tipo = (buscaState.tipo || '').trim();
    const categoria = (buscaState.categoria || '').trim();
    const unidade = (buscaState.unidade || '').trim();

    const lista = EstoqueStore.filter({
      texto: texto || undefined,
      tipo: tipo || undefined,
      categoria: categoria || undefined,
      unidade: unidade || undefined
    });

    EstoqueUI.renderLista(lista);
  }

  const aplicarBuscaEstoqueDebounced = debounce(aplicarBuscaEstoque, 200);

  function aplicarBuscaCompras() {
    if (!comprasEstaAtivo()) return;

    if (!window.ComprasStore || !window.ComprasUI) return;
    if (!ComprasStore.isLoaded()) return;

    const texto = (buscaStateCompras.texto || '').trim();
    const tipo = (buscaStateCompras.tipo || '').trim();
    const categoria = (buscaStateCompras.categoria || '').trim();
    const unidade = (buscaStateCompras.unidade || '').trim();

    const lista = ComprasStore.filter({
      texto: texto || undefined,
      tipo: tipo || undefined,
      categoria: categoria || undefined,
      unidade: unidade || undefined
    });

    ComprasUI.renderLista(lista);
  }

  const aplicarBuscaComprasDebounced = debounce(aplicarBuscaCompras, 200);

  function aplicarBuscaProdutos() {
    if (!produtosEstaAtivo()) return;

    if (!window.ProdutosStore || !window.ProdutosUI) return;
    if (!ProdutosStore.isLoaded()) return;

    const texto = (buscaStateProdutos.texto || '').trim();

    const lista = ProdutosStore.filter({
      texto: texto || undefined
    });

    ProdutosUI.renderLista(lista);
  }

  const aplicarBuscaProdutosDebounced = debounce(aplicarBuscaProdutos, 200);

  /* =========================
     PAINEL DE FILTRO (UI)
  ========================== */
  function painelFiltroExiste() {
    return !!document.getElementById('painelFiltroEstoque');
  }

  let listenerFecharForaAtivo = false;

  function abrirPainelFiltro() {
    const p = document.getElementById('painelFiltroEstoque');
    if (!p) return;

    p.classList.remove('hidden');

    // evita adicionar o listener várias vezes
    if (!listenerFecharForaAtivo) {
      listenerFecharForaAtivo = true;
      document.addEventListener('pointerdown', fecharFiltroAoClicarFora, { capture: true });
    }
  }

  function fecharPainelFiltro() {
    const p = document.getElementById('painelFiltroEstoque');
    if (!p) return;

    p.classList.add('hidden');

    if (listenerFecharForaAtivo) {
      listenerFecharForaAtivo = false;
      document.removeEventListener('pointerdown', fecharFiltroAoClicarFora, { capture: true });
    }
  }

  function togglePainelFiltro() {
    const p = document.getElementById('painelFiltroEstoque');
    if (!p) return;

    if (p.classList.contains('hidden')) abrirPainelFiltro();
    else fecharPainelFiltro();
  }

  function fecharFiltroAoClicarFora(e) {
    const p = document.getElementById('painelFiltroEstoque');
    if (!p || p.classList.contains('hidden')) return;

    const btn = document.getElementById('btnFiltro');
    if (p.contains(e.target)) return;
    if (btn && btn.contains(e.target)) return;

    fecharPainelFiltro();
  }

  function painelFiltroComprasExiste() {
    return !!document.getElementById('painelFiltroCompras');
  }

  let listenerFecharForaComprasAtivo = false;

  function abrirPainelFiltroCompras() {
    const p = document.getElementById('painelFiltroCompras');
    if (!p) return;

    p.classList.remove('hidden');

    if (!listenerFecharForaComprasAtivo) {
      listenerFecharForaComprasAtivo = true;
      document.addEventListener('pointerdown', fecharFiltroComprasAoClicarFora, { capture: true });
    }
  }

  function fecharPainelFiltroCompras() {
    const p = document.getElementById('painelFiltroCompras');
    if (!p) return;

    p.classList.add('hidden');

    if (listenerFecharForaComprasAtivo) {
      listenerFecharForaComprasAtivo = false;
      document.removeEventListener('pointerdown', fecharFiltroComprasAoClicarFora, { capture: true });
    }
  }

  function togglePainelFiltroCompras() {
    const p = document.getElementById('painelFiltroCompras');
    if (!p) return;

    if (p.classList.contains('hidden')) abrirPainelFiltroCompras();
    else fecharPainelFiltroCompras();
  }

  function fecharFiltroComprasAoClicarFora(e) {
    const p = document.getElementById('painelFiltroCompras');
    if (!p || p.classList.contains('hidden')) return;

    const btn = document.getElementById('btnFiltroCompras');
    if (p.contains(e.target)) return;
    if (btn && btn.contains(e.target)) return;

    fecharPainelFiltroCompras();
  }

  function limparFiltros() {
    buscaState.tipo = '';
    buscaState.categoria = '';
    buscaState.unidade = '';

    const tipo = document.getElementById('filtroTipo');
    const categoria = document.getElementById('filtroCategoria');
    const unidade = document.getElementById('filtroUnidade');

    if (tipo) tipo.value = '';
    if (categoria) categoria.value = '';
    if (unidade) unidade.value = '';

    aplicarBuscaEstoque();
  }

  function limparFiltrosCompras() {
    buscaStateCompras.tipo = '';
    buscaStateCompras.categoria = '';
    buscaStateCompras.unidade = '';

    const tipo = document.getElementById('filtroTipoCompras');
    const categoria = document.getElementById('filtroCategoriaCompras');
    const unidade = document.getElementById('filtroUnidadeCompras');

    if (tipo) tipo.value = '';
    if (categoria) categoria.value = '';
    if (unidade) unidade.value = '';

    aplicarBuscaCompras();
  }

  /* =========================
     POPULAR SELECTS DO PAINEL
     (usa o cache do EstoqueStore)
  ========================== */
  function uniqueSorted(arr) {
    return [...new Set(arr.filter(v => String(v || '').trim() !== ''))]
      .map(v => String(v).trim())
      .sort((a, b) => a.localeCompare(b));
  }

  function preencherSelect(selectEl, valores, placeholder) {
    if (!selectEl) return;

    selectEl.innerHTML = '';
    const opt0 = document.createElement('option');
    opt0.value = '';
    opt0.textContent = placeholder;
    selectEl.appendChild(opt0);

    valores.forEach(v => {
      const o = document.createElement('option');
      o.value = v;
      o.textContent = v;
      selectEl.appendChild(o);
    });
  }

  function popularFiltrosDoPainel() {
    if (!window.EstoqueStore) return;
    if (!EstoqueStore.isLoaded()) return;

    const itens = EstoqueStore.get();

    const tipos = uniqueSorted(itens.map(i => i.tipo));
    const categorias = uniqueSorted(itens.map(i => i.categoria));
    const unidades = uniqueSorted(itens.map(i => i.unidade));

    const selTipo = document.getElementById('filtroTipo');
    const selCategoria = document.getElementById('filtroCategoria');
    const selUnidade = document.getElementById('filtroUnidade');

    // preserva seleção atual (se já tiver)
    const tipoAtual = selTipo ? selTipo.value : '';
    const catAtual = selCategoria ? selCategoria.value : '';
    const unidadeAtual = selUnidade ? selUnidade.value : '';

    preencherSelect(selTipo, tipos, 'Tipo (todos)');
    preencherSelect(selUnidade, unidades, 'Unidade (todas)');
    preencherSelect(selCategoria, categorias, 'Categoria (todas)');

    // restaura se ainda existir
    if (selTipo && tipos.includes(tipoAtual)) selTipo.value = tipoAtual;
    if (selCategoria && categorias.includes(catAtual)) selCategoria.value = catAtual;
    if (selUnidade && unidades.includes(unidadeAtual)) selUnidade.value = unidadeAtual;
  }

  // espera o EstoqueStore carregar (sem travar nada)
  let filtroPoll = null;
  function iniciarPollFiltros() {
    if (!painelFiltroExiste()) return;

    // evita múltiplos polls
    if (filtroPoll) return;

    filtroPoll = setInterval(() => {
      if (window.EstoqueStore && EstoqueStore.isLoaded()) {
        popularFiltrosDoPainel();
        clearInterval(filtroPoll);
        filtroPoll = null;
      }
    }, 300);
  }

  function popularFiltrosDoPainelCompras() {
    if (!window.ComprasStore) return;
    if (!ComprasStore.isLoaded()) return;

    const itens = ComprasStore.get();

    const tipos = uniqueSorted(itens.map(i => i.tipo));
    const categorias = uniqueSorted(itens.map(i => i.categoria));
    const unidades = uniqueSorted(itens.map(i => i.unidade));

    const selTipo = document.getElementById('filtroTipoCompras');
    const selCategoria = document.getElementById('filtroCategoriaCompras');
    const selUnidade = document.getElementById('filtroUnidadeCompras');

    const tipoAtual = selTipo ? selTipo.value : '';
    const catAtual = selCategoria ? selCategoria.value : '';
    const unidadeAtual = selUnidade ? selUnidade.value : '';

    preencherSelect(selTipo, tipos, 'Tipo (todos)');
    preencherSelect(selUnidade, unidades, 'Unidade (todas)');
    preencherSelect(selCategoria, categorias, 'Categoria (todas)');

    if (selTipo && tipos.includes(tipoAtual)) selTipo.value = tipoAtual;
    if (selCategoria && categorias.includes(catAtual)) selCategoria.value = catAtual;
    if (selUnidade && unidades.includes(unidadeAtual)) selUnidade.value = unidadeAtual;
  }

  let filtroPollCompras = null;
  function iniciarPollFiltrosCompras() {
    if (!painelFiltroComprasExiste()) return;
    if (filtroPollCompras) return;

    filtroPollCompras = setInterval(() => {
      if (window.ComprasStore && ComprasStore.isLoaded()) {
        popularFiltrosDoPainelCompras();
        clearInterval(filtroPollCompras);
        filtroPollCompras = null;
      }
    }, 300);
  }

  /* =========================
     INIT BUSCA/FILTRO
  ========================== */
  function initBuscaEFiltroEstoque() {
    const input = document.getElementById('buscaEstoque');
    const btnFiltro = document.getElementById('btnFiltro');

    // busca
    if (input) {
      input.addEventListener('input', () => {
        buscaState.texto = input.value || '';
        aplicarBuscaEstoqueDebounced();
      });
    }

    // botão filtro
    if (btnFiltro) {
      btnFiltro.addEventListener('click', () => {
        if (!painelFiltroExiste()) {
          mostrarToast('Filtro avançado em breve');
          return;
        }
        togglePainelFiltro();
      });
    }

    // listeners do painel (se existir)
    const p = document.getElementById('painelFiltroEstoque');
    if (!p) return;

    const tipo = document.getElementById('filtroTipo');
    const categoria = document.getElementById('filtroCategoria');
    const unidade = document.getElementById('filtroUnidade');
    const btnLimpar = document.getElementById('btnLimparFiltros'); // ✅ seu ID correto

    // muda e aplica automaticamente
    [tipo, categoria, unidade].forEach(sel => {
      if (!sel) return;
      sel.addEventListener('change', () => {
        lerFiltrosDoPainel();
        aplicarBuscaEstoque();
      });
    });

    if (btnLimpar) {
      btnLimpar.addEventListener('click', () => {
        limparFiltros();
      });
    }

    // garante opções preenchidas assim que o store carregar
    iniciarPollFiltros();
  }

  function initBuscaEFiltroCompras() {
    const input = document.getElementById('buscaCompras');
    const btnFiltro = document.getElementById('btnFiltroCompras');

    if (input) {
      input.addEventListener('input', () => {
        buscaStateCompras.texto = input.value || '';
        aplicarBuscaComprasDebounced();
      });
    }

    if (btnFiltro) {
      btnFiltro.addEventListener('click', () => {
        if (!painelFiltroComprasExiste()) {
          mostrarToast('Filtro avanAado em breve');
          return;
        }
        togglePainelFiltroCompras();
      });
    }

    const p = document.getElementById('painelFiltroCompras');
    if (!p) return;

    const tipo = document.getElementById('filtroTipoCompras');
    const categoria = document.getElementById('filtroCategoriaCompras');
    const unidade = document.getElementById('filtroUnidadeCompras');
    const btnLimpar = document.getElementById('btnLimparFiltrosCompras');

    [tipo, categoria, unidade].forEach(sel => {
      if (!sel) return;
      sel.addEventListener('change', () => {
        lerFiltrosDoPainelCompras();
        aplicarBuscaCompras();
      });
    });

    if (btnLimpar) {
      btnLimpar.addEventListener('click', () => {
        limparFiltrosCompras();
      });
    }

    iniciarPollFiltrosCompras();
  }

  function initBuscaProdutos() {
    const input = document.getElementById('buscaProdutos');
    const btnFiltro = document.getElementById('btnFiltroProdutos');

    if (input) {
      input.addEventListener('input', () => {
        buscaStateProdutos.texto = input.value || '';
        aplicarBuscaProdutosDebounced();
      });
    }

    if (btnFiltro) {
      btnFiltro.addEventListener('click', () => {
        mostrarToast('Filtro avancado em breve');
      });
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    trocarAba('estoque');
    initBuscaEFiltroEstoque();
    initBuscaEFiltroCompras();
    initBuscaProdutos();
  });
</script>
