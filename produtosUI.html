<script>
  window.ProdutosUI = (() => {
    let cardAberto = null;
    let delegationInit = false;

    let opcoesEstoque = [];
    let opcoesProdutos = [];

    /* =========================
       HELPERS
    ========================== */
    function el() {
      return {
        formulario: document.getElementById('formularioProduto'),
        lista: document.getElementById('listaProdutos'),

        nome: document.getElementById('produtoNome'),
        descricao: document.getElementById('produtoDescricao'),
        observacao: document.getElementById('produtoObservacao'),
        formTitulo: document.getElementById('produtoFormTitulo')
      };
    }

    function setOpcoesComposicao({ estoque, produtos } = {}) {
      opcoesEstoque = Array.isArray(estoque) ? estoque : [];
      opcoesProdutos = Array.isArray(produtos) ? produtos : [];
    }

    function getNomeItem(tipo, id) {
      if (!tipo || !id) return '';
      if (tipo === 'PRODUTO') {
        const p = opcoesProdutos.find(i => i.produto_id === id);
        return p ? (p.nome_produto || id) : id;
      }
      const e = opcoesEstoque.find(i => i.ID === id);
      return e ? (e.item || id) : id;
    }

    /* =========================
       FORMULARIO
    ========================== */
    function abrirFormularioNovo() {
      resetFormulario();
      mostrarFormulario();
    }

    function mostrarFormulario() {
      const { formulario } = el();
      if (!formulario) return;

      formulario.style.display = 'block';

      requestAnimationFrame(() => {
        formulario.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
    }

    function fecharFormulario() {
      const { formulario } = el();
      if (!formulario) return;

      formulario.style.display = 'none';
      resetFormulario();

      if (window.ProdutosController) {
        ProdutosController.limparEdicao();
      }
    }

    function preencherFormulario(data) {
      const f = el();

      if (f.nome) f.nome.value = data.nome_produto || '';
      if (f.descricao) f.descricao.value = data.descricao || '';
      if (f.observacao) f.observacao.value = data.observacao || '';

      if (f.formTitulo) f.formTitulo.innerText = 'Editar Produto';
    }

    function resetFormulario() {
      const f = el();

      [
        f.nome,
        f.descricao,
        f.observacao
      ].forEach(i => i && (i.value = ''));

      if (f.formTitulo) f.formTitulo.innerText = 'Novo Produto';
    }

    /* =========================
       COMPOSICAO
    ========================== */
    function renderLinhaComposicao(linha) {
      const nomeItem = getNomeItem(linha.tipo_item, linha.item_id);
      const qtd = linha.quantidade !== undefined && linha.quantidade !== null
        ? linha.quantidade
        : '';
      const unidade = linha.unidade || '';

      return `
        <div class="linha-composicao">
          <div class="comp-info">
            <div><strong>${nomeItem || linha.item_id || '-'}</strong></div>
            <div class="comp-meta">${linha.tipo_item || '-'} - ${qtd} ${unidade}</div>
          </div>
        </div>
      `;
    }

    function renderComposicao(linhas, carregada) {
      if (!carregada) {
        return '<p>Composicao nao carregada.</p>';
      }

      if (!Array.isArray(linhas) || linhas.length === 0) {
        return '<p>Nenhum item na composicao.</p>';
      }

      return linhas.map(l => renderLinhaComposicao(l)).join('');
    }

    /* =========================
       LISTA + CARDS
    ========================== */
    function renderLista(itens) {
      const { lista } = el();
      if (!lista) return;

      const abertoId = cardAberto ? cardAberto.dataset.id : null;
      cardAberto = null;
      lista.innerHTML = '';

      if (!Array.isArray(itens) || itens.length === 0) {
        lista.innerHTML = '<p>Nenhum produto cadastrado.</p>';
        return;
      }

      itens.forEach(i => {
        const div = document.createElement('div');
        div.className = 'card';
        div.dataset.id = i.produto_id;

        const custo = Number(i.custo_previsto || 0);
        const custoTexto = isNaN(custo) ? '-' : custo.toFixed(2);
        const custoLinha = i.custo_erro
          ? 'Custo: erro'
          : `Custo: R$ ${custoTexto}`;

        const comp = Array.isArray(i.composicao) ? i.composicao : [];
        const compCarregada = !!i.composicaoCarregada;

        div.innerHTML = `
          <div class="card-resumo">
            <strong>${i.nome_produto || i.produto_id}</strong><br>
            ${custoLinha}<br>
            ${i.descricao || '-'}
          </div>

          <button class="ver-mais">Ver mais</button>

          <div class="card-detalhes">
            <button class="fechar-card">X</button>

            <p><b>Descricao:</b> ${i.descricao || '-'}</p>
            <p><b>Observacao:</b> ${i.observacao || '-'}</p>

            <div class="bloco">
              <p><b>Composicao</b></p>
              ${renderComposicao(comp, compCarregada)}
            </div>

            <div class="acoes">
              <button onclick="ProdutosController.editar('${i.produto_id}')">Editar</button>
              <button onclick="ProdutosController.excluir('${i.produto_id}')">Excluir</button>
            </div>
          </div>
        `;

        lista.appendChild(div);
      });

      initDelegation();

      if (abertoId) {
        const alvo = lista.querySelector(`.card[data-id="${abertoId}"]`);
        if (alvo) {
          abrirCard(alvo);
        }
      }
    }

    /* =========================
       EVENT DELEGATION
    ========================== */
    function initDelegation() {
      if (delegationInit) return;
      delegationInit = true;

      document.addEventListener('click', e => {
        const card = e.target.closest('.card');
        const lista = document.getElementById('listaProdutos');

        if (card && lista && !lista.contains(card)) return;

        if (e.target.classList.contains('ver-mais')) {
          e.stopPropagation();
          abrirCard(card);
          if (card && window.ProdutosController) {
            ProdutosController.carregarComposicao(card.dataset.id);
          }
          return;
        }

        if (e.target.classList.contains('fechar-card')) {
          e.stopPropagation();
          fecharCard();
          return;
        }

        if (cardAberto && !cardAberto.contains(e.target)) {
          fecharCard();
        }
      });
    }

    function abrirCard(card) {
      if (!card) return;

      if (cardAberto && cardAberto !== card) {
        fecharCard();
      }
      card.classList.add('aberto');
      cardAberto = card;
    }

    function fecharCard() {
      if (!cardAberto) return;
      cardAberto.classList.remove('aberto');
      cardAberto = null;
    }

    /* =========================
       API PUBLICA
    ========================== */
    return {
      abrirFormularioNovo,
      mostrarFormulario,
      fecharFormulario,
      preencherFormulario,
      resetFormulario,
      renderLista,
      setOpcoesComposicao
    };

  })();
</script>