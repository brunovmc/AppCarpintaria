<script>
  window.ComprasUI = (() => {
    let cardAberto = null;
    let delegationInit = false;

    /* =========================
       HELPERS
    ========================== */
    function el() {
      return {
        formulario: document.getElementById('formularioCompra'),
        lista: document.getElementById('listaCompras'),

        // Form
        tipo: document.getElementById('compraTipo'),
        item: document.getElementById('compraItem'),
        quantidade: document.getElementById('compraQuantidade'),
        unidade: document.getElementById('compraUnidade'),
        categoria: document.getElementById('compraCategoria'),
        fornecedor: document.getElementById('compraFornecedor'),
        valor_unit: document.getElementById('compraValorUnit'),
        observacao: document.getElementById('compraObservacao'),

        potencia: document.getElementById('compraPotencia'),
        voltagem: document.getElementById('compraVoltagem'),
        comprado_em: document.getElementById('compraCompradoEm'),
        vida_util_mes: document.getElementById('compraVidaUtilMes'),

        equipamentoFields: document.getElementById('compraEquipamentoFields'),
        formTitulo: document.getElementById('compraFormTitulo')
      };
    }

    function limparVazios(lista) {
      return (Array.isArray(lista) ? lista : [])
        .map(v => (v ?? '').toString().trim())
        .filter(v => v !== '');
    }

    /* =========================
       FORMULARIO
    ========================== */
    function abrirFormularioNovo() {
      resetFormulario();
      mostrarFormulario();
    }

    function mostrarFormulario() {
      const { formulario } = el();
      if (!formulario) return;

      formulario.style.display = 'block';

      requestAnimationFrame(() => {
        formulario.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
    }

    function fecharFormulario() {
      const { formulario } = el();
      if (!formulario) return;

      formulario.style.display = 'none';
      resetFormulario();

      if (window.ComprasController) {
        ComprasController.limparEdicao();
      }
    }

    function preencherFormulario(data) {
      const f = el();

      if (f.tipo) f.tipo.value = data.tipo || '';
      if (f.unidade) f.unidade.value = data.unidade || '';

      if (f.item) f.item.value = data.item || '';
      if (f.quantidade) f.quantidade.value = data.quantidade || '';

      if (f.categoria) f.categoria.value = data.categoria || '';
      if (f.fornecedor) f.fornecedor.value = data.fornecedor || '';

      if (f.valor_unit) f.valor_unit.value = data.valor_unit || '';
      if (f.observacao) f.observacao.value = data.observacao || '';

      if (f.potencia) f.potencia.value = data.potencia || '';
      if (f.voltagem) f.voltagem.value = data.voltagem || '';
      if (f.comprado_em) f.comprado_em.value = data.comprado_em || '';
      if (f.vida_util_mes) f.vida_util_mes.value = data.vida_util_mes || '';

      if (f.formTitulo) f.formTitulo.innerText = 'Editar Compra';
      handleTipoChange();
    }

    function resetFormulario() {
      const f = el();

      [
        f.tipo,
        f.item,
        f.quantidade,
        f.unidade,
        f.categoria,
        f.fornecedor,
        f.valor_unit,
        f.observacao,
        f.potencia,
        f.voltagem,
        f.comprado_em,
        f.vida_util_mes
      ].forEach(i => i && (i.value = ''));

      if (f.equipamentoFields) f.equipamentoFields.classList.add('hidden');
      if (f.formTitulo) f.formTitulo.innerText = 'Nova Compra';
    }

    function handleTipoChange() {
      const { tipo, equipamentoFields } = el();
      if (!tipo || !equipamentoFields) return;

      equipamentoFields.classList.toggle(
        'hidden',
        tipo.value !== 'EQUIPAMENTO'
      );
    }

    /* =========================
       SELECTS (RENDER ONLY)
    ========================== */
    function renderTipos(lista) {
      const { tipo } = el();
      if (!tipo) return;

      const clean = limparVazios(lista);

      tipo.innerHTML = '<option value="">Selecione</option>';
      clean.forEach(v => {
        const o = document.createElement('option');
        o.value = v;
        o.textContent = v;
        tipo.appendChild(o);
      });
    }

    function renderUnidades(lista) {
      const { unidade } = el();
      if (!unidade) return;

      const clean = limparVazios(lista);

      unidade.innerHTML = '<option value="">Selecione</option>';
      clean.forEach(v => {
        const o = document.createElement('option');
        o.value = v;
        o.textContent = v;
        unidade.appendChild(o);
      });
    }

    function renderCategorias(lista) {
      const { categoria } = el();
      if (!categoria) return;

      const clean = limparVazios(lista);

      if (categoria.tagName === 'SELECT') {
        categoria.innerHTML = '<option value="">Selecione</option>';
        clean.forEach(v => {
          const o = document.createElement('option');
          o.value = v;
          o.textContent = v;
          categoria.appendChild(o);
        });
      }
    }

    function renderFornecedores(lista) {
      const { fornecedor } = el();
      if (!fornecedor) return;

      const clean = limparVazios(lista);

      if (fornecedor.tagName === 'SELECT') {
        fornecedor.innerHTML = '<option value="">Selecione</option>';
        clean.forEach(v => {
          const o = document.createElement('option');
          o.value = v;
          o.textContent = v;
          fornecedor.appendChild(o);
        });
      }
    }

    /* =========================
       LISTA + CARDS
    ========================== */
    function renderLista(itens) {
      const { lista } = el();
      if (!lista) return;

      lista.innerHTML = '';

      if (!Array.isArray(itens) || itens.length === 0) {
        lista.innerHTML = '<p>Nenhum item em compras.</p>';
        return;
      }

      itens.forEach(i => {
        const div = document.createElement('div');
        div.className = 'card';
        div.dataset.id = i.ID;

        div.innerHTML = `
          <div class="card-resumo">
            <strong>${i.item}</strong><br>
            ${i.tipo} > ${i.categoria || '-'}<br>
            ${i.quantidade || 0} ${i.unidade || ''}
          </div>

          <button class="ver-mais">Ver mais</button>

          <div class="card-detalhes">
            <button class="fechar-card">X</button>

            <p><b>Fornecedor:</b> ${i.fornecedor || '-'}</p>
            <p><b>Valor unitario:</b> R$ ${Number(i.valor_unit || 0).toFixed(2)}</p>
            <p><b>Observacao:</b> ${i.observacao || '-'}</p>

            ${i.tipo === 'EQUIPAMENTO' ? `
              <p><b>Potencia:</b> ${i.potencia || '-'}</p>
              <p><b>Voltagem:</b> ${i.voltagem || '-'}</p>
            ` : ''}

            <div class="acoes">
              <button onclick="ComprasController.adicionarAoEstoque('${i.ID}')">Adicionar ao estoque</button>
              <button onclick="ComprasController.editar('${i.ID}')">Editar</button>
              <button onclick="ComprasController.excluir('${i.ID}')">Excluir</button>
            </div>
          </div>
        `;

        lista.appendChild(div);
      });

      initDelegation();
    }

    /* =========================
       EVENT DELEGATION
    ========================== */
    function initDelegation() {
      if (delegationInit) return;
      delegationInit = true;

      document.addEventListener('click', e => {
        const card = e.target.closest('.card');
        const lista = document.getElementById('listaCompras');

        if (card && lista && !lista.contains(card)) return;

        if (e.target.classList.contains('ver-mais')) {
          e.stopPropagation();
          abrirCard(card);
          return;
        }

        if (e.target.classList.contains('fechar-card')) {
          e.stopPropagation();
          fecharCard();
          return;
        }

        if (cardAberto && !cardAberto.contains(e.target)) {
          fecharCard();
        }
      });
    }

    function abrirCard(card) {
      if (!card) return;

      if (cardAberto && cardAberto !== card) {
        fecharCard();
      }
      card.classList.add('aberto');
      cardAberto = card;
    }

    function fecharCard() {
      if (!cardAberto) return;
      cardAberto.classList.remove('aberto');
      cardAberto = null;
    }

    /* =========================
       API PUBLICA
    ========================== */
    return {
      abrirFormularioNovo,
      mostrarFormulario,
      fecharFormulario,
      preencherFormulario,
      resetFormulario,
      handleTipoChange,
      renderLista,

      renderTipos,
      renderUnidades,
      renderCategorias,
      renderFornecedores
    };

  })();
</script>
