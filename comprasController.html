<script>
  window.ComprasController = (() => {

    let editandoId = null;
    let iniciado = false;
    const adicionandoAoEstoque = new Set();

    let validacoes = null;

    function init() {
      if (iniciado) return;

      carregarValidacoes();
      carregarCompras();

      iniciado = true;
    }

    function carregarValidacoes() {
      google.script.run
        .withSuccessHandler(data => {
          validacoes = data || {};

          validacoes.tipos ||= [];
          validacoes.unidades ||= [];
          validacoes.categorias ||= [];
          validacoes.fornecedores ||= [];

          ComprasUI.renderTipos?.(validacoes.tipos);
          ComprasUI.renderUnidades?.(validacoes.unidades);
          ComprasUI.renderCategorias?.(validacoes.categorias);
          ComprasUI.renderFornecedores?.(validacoes.fornecedores);
        })
        .obterValidacoes();
    }

    function renderListaAtual() {
      if (window.aplicarBuscaCompras) {
        aplicarBuscaCompras();
        return;
      }
      ComprasUI.renderLista(ComprasStore.get());
    }

    function carregarCompras() {
      google.script.run
        .withSuccessHandler(lista => {
          ComprasStore.set(lista);
          renderListaAtual();
        })
        .listarCompras();
    }

    function salvar() {
      const get = id => document.getElementById(id)?.value || '';
      const parseNumeroInput = valor => {
        const s = String(valor ?? '').trim();
        if (s === '') return '';
        const n = Number(s.replace(',', '.'));
        return isNaN(n) ? '' : n;
      };

      const tipo = get('compraTipo');
      const comprimento_cm = tipo === 'MADEIRA' ? parseNumeroInput(get('compraComprimentoCm')) : '';
      const largura_cm = tipo === 'MADEIRA' ? parseNumeroInput(get('compraLarguraCm')) : '';
      const espessura_cm = tipo === 'MADEIRA' ? parseNumeroInput(get('compraEspessuraCm')) : '';
      const qtdMadeira = (tipo === 'MADEIRA' && comprimento_cm && largura_cm && espessura_cm)
        ? Number(((comprimento_cm * largura_cm * espessura_cm) / 1000000).toFixed(2))
        : '';

      const dados = {
        tipo,
        item: get('compraItem'),
        quantidade: tipo === 'MADEIRA' && qtdMadeira !== '' ? qtdMadeira : Number(get('compraQuantidade')) || 0,
        unidade: tipo === 'MADEIRA' ? 'M3' : get('compraUnidade'),
        categoria: get('compraCategoria'),
        fornecedor: get('compraFornecedor'),
        valor_unit: Number(get('compraValorUnit')) || 0,
        observacao: get('compraObservacao'),

        comprimento_cm,
        largura_cm,
        espessura_cm,

        potencia: get('compraPotencia'),
        voltagem: get('compraVoltagem'),
        comprado_em: get('compraCompradoEm'),
        vida_util_mes: Number(get('compraVidaUtilMes')) || ''
      };

      if (editandoId) {
        const idAtual = editandoId;
        const snapshot = { ...ComprasStore.getById(idAtual) };

        ComprasStore.update(idAtual, dados);
        renderListaAtual();
        finalizarUX();

        google.script.run
          .withFailureHandler(() => {
            ComprasStore.update(idAtual, snapshot);
            renderListaAtual();
            mostrarToast('Erro ao salvar edicao', 'erro');
          })
          .withSuccessHandler(() => {
            mostrarToast('Salvo com sucesso');
          })
          .atualizarItemCompra(idAtual, dados);

        editandoId = null;
        return;
      }

      const tempId = `tmp_${Date.now()}`;

      const itemTemp = {
        ID: tempId,
        ...dados
      };

      ComprasStore.add(itemTemp);
      renderListaAtual();
      finalizarUX();
      mostrarToast('Salvando...');

      google.script.run
        .withFailureHandler(() => {
          ComprasStore.remove(tempId);
          renderListaAtual();
          mostrarToast('Erro ao salvar compra', 'erro');
        })
        .withSuccessHandler(itemSalvo => {
          ComprasStore.remove(tempId);

          if (!itemSalvo || !itemSalvo.ID) {
            mostrarToast('Salvo. Atualizando lista...');
            carregarCompras();
            return;
          }

          ComprasStore.add(itemSalvo);
          renderListaAtual();
          mostrarToast('Salvo com sucesso');
        })
        .criarItemCompra(dados);
    }

    function finalizarUX() {
      ComprasUI.fecharFormulario();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function editar(id) {
      const item = ComprasStore.getById(id);

      if (!item) {
        mostrarToast('Item nao encontrado', 'erro');
        return;
      }

      editandoId = id;
      ComprasUI.preencherFormulario(item);
      ComprasUI.mostrarFormulario();
    }

    function excluir(id) {
      if (!confirm('Deseja remover esta compra?')) return;

      const snapshot = ComprasStore.getById(id);

      ComprasStore.remove(id);
      renderListaAtual();
      mostrarToast('Compra removida');

      google.script.run
        .withFailureHandler(() => {
          ComprasStore.add(snapshot);
          renderListaAtual();
          mostrarToast('Erro ao remover', 'erro');
        })
        .deletarItemCompra(id);
    }

    function adicionarAoEstoque(id) {
      if (adicionandoAoEstoque.has(id)) return;
      if (!confirm('Adicionar esta compra ao estoque?')) return;

      const snapshot = ComprasStore.getById(id);
      if (!snapshot) {
        mostrarToast('Compra nao encontrada', 'erro');
        return;
      }

      adicionandoAoEstoque.add(id);
      ComprasStore.remove(id);
      renderListaAtual();
      mostrarToast('Adicionando ao estoque...');

      google.script.run
        .withFailureHandler(() => {
          adicionandoAoEstoque.delete(id);
          ComprasStore.add(snapshot);
          renderListaAtual();
          mostrarToast('Erro ao adicionar ao estoque', 'erro');
        })
        .withSuccessHandler(resp => {
          adicionandoAoEstoque.delete(id);
          if (resp?.itemEstoqueCriado && window.EstoqueStore) {
            // Se o estoque ainda nao foi carregado, add nao liga o flag isLoaded.
            const atual = EstoqueStore.isLoaded() ? EstoqueStore.get() : [];
            EstoqueStore.set([resp.itemEstoqueCriado, ...atual]);
            if (typeof aplicarBuscaEstoque === 'function') {
              aplicarBuscaEstoque();
            } else if (window.EstoqueUI?.renderLista) {
              EstoqueUI.renderLista(EstoqueStore.get());
            }
          }
          if (window.EstoqueController?.syncFromBackend) {
            EstoqueController.syncFromBackend();
          }
          mostrarToast('Adicionado ao estoque');
        })
        .adicionarCompraAoEstoque(id);
    }

    function limparEdicao() {
      editandoId = null;
    }

    return {
      init,
      salvar,
      editar,
      excluir,
      adicionarAoEstoque,
      limparEdicao
    };

  })();
</script>
